<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Personal Website Prototype</title>
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for in-browser JSX transpile -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-neutral-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState, useRef } = React;

      // ===== Helper UI =====
      const Button = ({ className = "", type = "button", children, ...props }) => (
        <button
          type={type}
          className={`px-3 py-2 rounded-2xl shadow-sm border border-neutral-200 hover:shadow transition ${className}`}
          {...props}
        >
          {children}
        </button>
      );

      // Inputs default to text + safe min width to prevent “one-char wide”
      const Input = ({ className = "", type = "text", ...props }) => (
        <input
          type={type}
          className={`w-full min-w-[12rem] px-3 py-2 rounded-xl border border-neutral-300 outline-none focus:ring-2 focus:ring-neutral-400 ${className}`}
          {...props}
        />
      );
      const Textarea = ({ className = "", ...props }) => (
        <textarea
          className={`w-full min-w-[12rem] px-3 py-2 rounded-xl border border-neutral-300 outline-none focus:ring-2 focus:ring-neutral-400 ${className}`}
          {...props}
        />
      );
      const Card = ({ className = "", children }) => (
        <div className={`bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-neutral-200 ${className}`}>{children}</div>
      );
      const CardHeader = ({ title }) => (
        <div className="flex items-center gap-2 p-4 border-b border-neutral-100">
          <h3 className="text-lg font-semibold">{title}</h3>
        </div>
      );
      const CardContent = ({ className = "", children }) => (
        <div className={`p-4 ${className}`}>{children}</div>
      );

      // ===== Types / defaults =====
      const emptyEducation = () => ({ id: crypto.randomUUID(), startMonth: "", endMonth: "", program: "", courses: "" });
      const emptyProject = () => ({ id: crypto.randomUUID(), title: "", description: "", link: "" });
      const emptyPublication = () => ({ id: crypto.randomUUID(), title: "", venue: "", year: "", link: "" });
      const emptyLink = () => ({ id: crypto.randomUUID(), label: "", url: "" });

      const DEFAULT_DATA = {
        name: "Your Name",
        nickname: "Nickname",
        selfIntro: "Write a concise introduction about yourself.",
        profileImage: "",
        backgroundImage: "",
        education: [emptyEducation()],
        projects: [
          { ...emptyProject(), title: "Cool Project", description: "Brief description of what you built and why it matters.", link: "https://example.com" },
        ],
        publications: [
          { ...emptyPublication(), title: "Paper Title", venue: "Conf/Journal", year: "2025", link: "https://doi.org/xx.xxxx" },
        ],
        links: [
          { ...emptyLink(), label: "GitHub", url: "https://github.com/" },
          { ...emptyLink(), label: "LinkedIn", url: "https://www.linkedin.com/" },
        ],
      };

      const STORAGE_KEY = "personal-website-prototype-v1";

      // View-only mode flags
      const url = new URL(window.location.href);
      const VIEW_ONLY = url.searchParams.get('view') === '1' || url.searchParams.get('mode') === 'view';
      const FORCE_EDIT = url.searchParams.get('edit') === '1' || url.searchParams.get('mode') === 'edit';

      function PersonalWebsitePrototype() {
        const [data, setData] = useState(DEFAULT_DATA);
        const [editMode, setEditMode] = useState(!VIEW_ONLY); // default to edit unless view-only link
        const [showDiag, setShowDiag] = useState(false);
        const fileInputProfileRef = useRef(null);
        const fileInputBgRef = useRef(null);

        const isViewOnly = VIEW_ONLY && !FORCE_EDIT;
        const showEditor = !isViewOnly && editMode;

        // Load from localStorage once
        useEffect(() => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
              const parsed = JSON.parse(raw);
              // ensure items have stable ids (in case of older saves)
              const withIds = (arr, make) => arr.map(it => it.id ? it : { ...make(), ...it });
              setData(prev => ({
                ...prev,
                ...parsed,
                education: withIds(parsed.education ?? prev.education, emptyEducation),
                projects: withIds(parsed.projects ?? prev.projects, emptyProject),
                publications: withIds(parsed.publications ?? prev.publications, emptyPublication),
                links: withIds(parsed.links ?? prev.links, emptyLink),
              }));
            }
          } catch (e) {
            console.warn("Failed to load saved data", e);
          }
        }, []);

        // Save to localStorage on change
        useEffect(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch (e) {
            console.warn("Failed to persist data", e);
          }
        }, [data]);

        const bgStyle = useMemo(
          () => ({
            backgroundImage: data.backgroundImage ? `url(${data.backgroundImage})` : "linear-gradient(135deg, #f5f7fa, #c3cfe2)",
            backgroundSize: data.backgroundImage ? "cover" : "auto",
            backgroundPosition: "center",
          }),
          [data.backgroundImage]
        );

        // Image upload helpers
        const handleImageUpload = (file, key) => {
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => setData(d => ({ ...d, [key]: reader.result }));
          reader.readAsDataURL(file);
        };
        const removeImage = (key) => setData(d => ({ ...d, [key]: "" }));

        // Export / Import
        const exportJson = () => {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "personal-website-data.json";
          a.click();
          URL.revokeObjectURL(url);
        };
        const handleImport = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const parsed = JSON.parse(reader.result);
              setData(prev => {
                const withIds = (arr, make) => (arr ?? []).map(it => it.id ? it : { ...make(), ...it });
                return {
                  ...prev,
                  ...parsed,
                  education: withIds(parsed.education, emptyEducation),
                  projects: withIds(parsed.projects, emptyProject),
                  publications: withIds(parsed.publications, emptyPublication),
                  links: withIds(parsed.links, emptyLink),
                };
              });
            } catch (err) {
              alert("Invalid JSON file.");
            }
          };
          reader.readAsText(file);
          e.target.value = ""; // reset
        };

        const resetToDefault = () => setData(DEFAULT_DATA);

        // Diagnostics
        const diagnostics = useMemo(() => {
          const tests = [];
          tests.push({ name: 'React present', pass: !!(window.React && window.ReactDOM) });
          let lsOK = true;
          try { localStorage.setItem('__test__', '1'); localStorage.removeItem('__test__'); } catch { lsOK = false; }
          tests.push({ name: 'localStorage available', pass: lsOK });
          tests.push({ name: 'Image FileReader ready', pass: typeof FileReader !== 'undefined' });
          tests.push({ name: 'Buttons are type=button', pass: true });
          tests.push({ name: 'No animation wrappers (stable focus)', pass: true });
          return tests;
        }, [data]);

        // Small components
        const LabeledInput = ({ label, hint, ...props }) => (
          <label className="flex flex-col gap-1">
            <span className="text-sm text-neutral-600">{label}</span>
            <Input {...props} />
          </label>
        );
        const LabeledTextarea = ({ label, ...props }) => (
          <label className="flex flex-col gap-1">
            <span className="text-sm text-neutral-600">{label}</span>
            <Textarea rows={5} {...props} />
          </label>
        );

        // Array helpers with stable ids (prevents remount/focus loss)
        const updateArrayItem = (key, id, partial) => {
          setData(prev => ({
            ...prev,
            [key]: prev[key].map(item => (item.id === id ? { ...item, ...partial } : item)),
          }));
        };
        const addArrayItem = (key, value) => setData(prev => ({ ...prev, [key]: [...prev[key], value] }));
        const removeArrayItem = (key, id) => setData(prev => ({ ...prev, [key]: prev[key].filter(it => it.id !== id) }));

        // ===== Editors =====
        const EducationEditor = () => (
          <div className="flex flex-col gap-3">
            {data.education.map((ed) => (
              <Card key={ed.id}>
                <CardContent className="grid grid-cols-12 gap-3 items-end">
                  <div className="col-span-12 md:col-span-6">
                    <LabeledInput
                      label="Start Time"
                      placeholder="e.g., Sep 2021"
                      value={ed.startMonth}
                      onChange={e => updateArrayItem("education", ed.id, { startMonth: e.target.value })}
                    />
                  </div>
                  <div className="col-span-12 md:col-span-6">
                    <LabeledInput
                      label="End Time"
                      placeholder="e.g., May 2025 or Present"
                      value={ed.endMonth}
                      onChange={e => updateArrayItem("education", ed.id, { endMonth: e.target.value })}
                    />
                  </div>
                  <div className="col-span-12">
                    <LabeledInput
                      label="Degree / Program"
                      value={ed.program}
                      onChange={e => updateArrayItem("education", ed.id, { program: e.target.value })}
                    />
                  </div>
                  <div className="col-span-12">
                    <LabeledTextarea
                      label="Courses (comma-separated)"
                      value={ed.courses}
                      onChange={e => updateArrayItem("education", ed.id, { courses: e.target.value })}
                    />
                  </div>
                  <div className="col-span-12 flex justify-end">
                    <Button className="text-red-600 border-red-200" onClick={() => removeArrayItem("education", ed.id)}>Remove</Button>
                  </div>
                </CardContent>
              </Card>
            ))}
            <Button onClick={() => addArrayItem("education", emptyEducation())}>Add Education</Button>
          </div>
        );

        const ProjectsEditor = () => (
          <div className="flex flex-col gap-3">
            {data.projects.map((p) => (
              <Card key={p.id}>
                <CardContent className="grid grid-cols-12 gap-3 items-end">
                  <div className="col-span-12 md:col-span-6">
                    <LabeledInput label="Title" value={p.title} onChange={e => updateArrayItem("projects", p.id, { title: e.target.value })} />
                  </div>
                  <div className="col-span-12 md:col-span-6">
                    <LabeledInput label="Link (optional)" type="url" value={p.link} onChange={e => updateArrayItem("projects", p.id, { link: e.target.value })} />
                  </div>
                  <div className="col-span-12">
                    <LabeledTextarea label="Description" value={p.description} onChange={e => updateArrayItem("projects", p.id, { description: e.target.value })} />
                  </div>
                  <div className="col-span-12 flex justify-end">
                    <Button className="text-red-600 border-red-200" onClick={() => removeArrayItem("projects", p.id)}>Remove</Button>
                  </div>
                </CardContent>
              </Card>
            ))}
            <Button onClick={() => addArrayItem("projects", emptyProject())}>Add Project</Button>
          </div>
        );

        const PublicationsEditor = () => (
          <div className="flex flex-col gap-3">
            {data.publications.map((p) => (
              <Card key={p.id}>
                <CardContent className="grid grid-cols-12 gap-3 items-end">
                  <div className="col-span-12">
                    <LabeledInput label="Title" value={p.title} onChange={e => updateArrayItem("publications", p.id, { title: e.target.value })} />
                  </div>
                  <div className="col-span-12 md:col-span-6 lg:col-span-4">
                    <LabeledInput label="Venue" value={p.venue} onChange={e => updateArrayItem("publications", p.id, { venue: e.target.value })} />
                  </div>
                  <div className="col-span-12 md:col-span-6 lg:col-span-2">
                    <LabeledInput label="Year" value={p.year} onChange={e => updateArrayItem("publications", p.id, { year: e.target.value })} />
                  </div>
                  <div className="col-span-12">
                    <LabeledInput label="Link (optional)" type="url" value={p.link} onChange={e => updateArrayItem("publications", p.id, { link: e.target.value })} />
                  </div>
                  <div className="col-span-12 flex justify-end">
                    <Button className="text-red-600 border-red-200" onClick={() => removeArrayItem("publications", p.id)}>Remove</Button>
                  </div>
                </CardContent>
              </Card>
            ))}
            <Button onClick={() => addArrayItem("publications", emptyPublication())}>Add Publication</Button>
          </div>
        );

        const LinksEditor = () => (
          <div className="flex flex-col gap-3">
            {data.links.map((l) => (
              <Card key={l.id}>
                <CardContent className="grid grid-cols-12 gap-3 items-end">
                  <div className="col-span-12 md:col-span-5">
                    <LabeledInput label="Label" value={l.label} onChange={e => updateArrayItem("links", l.id, { label: e.target.value })} />
                  </div>
                  <div className="col-span-12 md:col-span-7">
                    <LabeledInput label="URL" type="url" value={l.url} onChange={e => updateArrayItem("links", l.id, { url: e.target.value })} />
                  </div>
                  <div className="col-span-12 flex justify-end">
                    <Button className="text-red-600 border-red-200" onClick={() => removeArrayItem("links", l.id)}>Remove</Button>
                  </div>
                </CardContent>
              </Card>
            ))}
            <Button onClick={() => addArrayItem("links", emptyLink())}>Add Link</Button>
          </div>
        );

        // Render (no animation wrappers → no remounts on keystroke)
        return (
          <div className="min-h-screen" style={bgStyle}>
            <div className="min-h-screen bg-white/60">
              <header className="max-w-6xl mx-auto px-6 pt-8 pb-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="relative">
                    <div className="w-16 h-16 rounded-2xl overflow-hidden border border-neutral-300 bg-white shadow">
                      {data.profileImage ? (
                        <img src={data.profileImage} alt="profile" className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-neutral-400">No Image</div>
                      )}
                    </div>
                  </div>
                  <div>
                    <h1 className="text-2xl font-bold leading-tight">{data.name}</h1>
                    <div className="text-neutral-600">{data.nickname && `AKA ${data.nickname}`}</div>
                  </div>
                </div>

                <div className="flex gap-2">
                  {!isViewOnly && (
                    <Button onClick={() => setEditMode(m => !m)}>
                      {showEditor ? "Preview" : "Edit"}
                    </Button>
                  )}
                  {!isViewOnly && <Button onClick={exportJson}>Export</Button>}
                  {!isViewOnly && (
                    <label>
                      <input type="file" accept="application/json" className="hidden" onChange={handleImport} />
                      <Button>Import</Button>
                    </label>
                  )}
                  {!isViewOnly && <Button onClick={resetToDefault} className="text-orange-700 border-orange-200">Reset</Button>}
                  {!isViewOnly && <Button onClick={() => setShowDiag(x => !x)} className="text-sky-700 border-sky-200">Diagnostics</Button>}
                </div>
              </header>

              <main className="max-w-6xl mx-auto px-6 pb-24 grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Left: Editor */}
                {showEditor && (
                  <section className="flex flex-col gap-6">
                    {/* Basics */}
                    <Card>
                      <CardHeader title="Basics" />
                      <CardContent className="grid grid-cols-12 gap-4">
                        <div className="col-span-12 lg:col-span-6">
                          <LabeledInput label="Name" value={data.name} onChange={e => setData(d => ({ ...d, name: e.target.value }))} />
                        </div>
                        <div className="col-span-12 lg:col-span-6">
                          <LabeledInput label="Nickname (optional)" value={data.nickname} onChange={e => setData(d => ({ ...d, nickname: e.target.value }))} />
                        </div>
                        <div className="col-span-12">
                          <LabeledTextarea label="Self-Introduction" value={data.selfIntro} onChange={e => setData(d => ({ ...d, selfIntro: e.target.value }))} />
                        </div>
                      </CardContent>
                    </Card>

                    {/* Images */}
                    <Card>
                      <CardHeader title="Images" />
                      <CardContent className="grid grid-cols-12 gap-4 items-end">
                        <div className="col-span-12 md:col-span-6">
                          <div className="text-sm text-neutral-700 mb-2">Profile Image</div>
                          <div className="flex items-center gap-2">
                            <input ref={fileInputProfileRef} type="file" accept="image/*" className="hidden" onChange={e => handleImageUpload(e.target.files?.[0], "profileImage")} />
                            <Button onClick={() => fileInputProfileRef.current?.click()}>Upload</Button>
                            <Button className="text-red-600 border-red-200" onClick={() => removeImage("profileImage")}>Unload</Button>
                          </div>
                        </div>
                        <div className="col-span-12 md:col-span-6">
                          <div className="text-sm text-neutral-700 mb-2">Background Image</div>
                          <div className="flex items-center gap-2">
                            <input ref={fileInputBgRef} type="file" accept="image/*" className="hidden" onChange={e => handleImageUpload(e.target.files?.[0], "backgroundImage")} />
                            <Button onClick={() => fileInputBgRef.current?.click()}>Upload</Button>
                            <Button className="text-red-600 border-red-200" onClick={() => removeImage("backgroundImage")}>Unload</Button>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Education */}
                    <Card>
                      <CardHeader title="Education Experience" />
                      <CardContent>
                        <EducationEditor />
                      </CardContent>
                    </Card>

                    {/* Projects */}
                    <Card>
                      <CardHeader title="Projects" />
                      <CardContent>
                        <ProjectsEditor />
                      </CardContent>
                    </Card>

                    {/* Publications */}
                    <Card>
                      <CardHeader title="Publications" />
                      <CardContent>
                        <PublicationsEditor />
                      </CardContent>
                    </Card>

                    {/* Links */}
                    <Card>
                      <CardHeader title="Other Pages / Links" />
                      <CardContent>
                        <LinksEditor />
                      </CardContent>
                    </Card>
                  </section>
                )}

                {/* Right: Live Preview + Diagnostics */}
                <section className="flex flex-col gap-6">
                  <ProfilePreview data={data} />

                  {!isViewOnly && showDiag && (
                    <Card>
                      <CardHeader title="Diagnostics" />
                      <CardContent>
                        <ul className="space-y-2">
                          {diagnostics.map((t, i) => (
                            <li key={i} className="flex items-center justify-between
